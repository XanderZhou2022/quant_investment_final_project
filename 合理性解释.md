### 1. 最初的数据：我们拿到的不是股票收益，而是“因子多空收益”

第一步，在天软里做的是横截面因子构建和分组：

* 股票池：上证50成分股（动态更新）
* 频率：月度
* 对每个调仓月：

  * 计算动量、价值、质量、风险、规模等因子在每只股票上的截面因子值；
  * 按因子对股票排序，做 5 分位分组（G1~G5）；
  * 构建多空组合：用 G5 组合收益减 G1 组合收益，得到该因子当月的**多空收益**。

这一操作本质上是把“因子”当作一种策略：
高因子值的一篮子股票做多，低因子值的一篮子股票做空，多空收益就是该因子的超额表现。

最终我们得到 factor_longshort（或者 final_factor_longshort.csv），每一行是一个月，每一列是一个因子：

* 行索引：month（如 2018-03-01）
* 列：MOM20、MOM120、RSI、PB⁻¹、PE⁻¹、DIV、ROE、PROFIT_GR、VOL、BETA 等
* 数值：当月该因子的**多空收益**（G5-G1）

也就是说，从一开始，我们要研究和预测的对象就不是“某只股票的收益”，而是“某个因子组合的多空收益”。

---

### 2. 引入市场状态（Regime），但目标仍然是“下一期因子多空收益”

接着，我们用上证50指数构建了市场状态：

* 用月度收益、波动率、成交量等指标，通过聚类识别出三类 Regime：

  * Regime_Bull（慢牛）
  * Regime_Bear（下跌/压力）
  * Regime_Sideways（震荡/高波动）

然后把每个月的 Regime 标签合并到因子收益表中，形成 final_factor_longshort：

* month
* 因子多空收益（MOM20, …, BETA）
* regime（文本标签，后面会 one-hot）

在这一步，我们做了很多统计分析（例如各因子在不同 Regime 下的平均收益、夏普比），目的是证明：

> 因子多空收益在不同市场状态下表现差异显著，存在“因子轮动”。

但注意一点：
**这里的分析和后面的机器学习目标是同一个量：因子多空收益。**
Regime 只是用来解释和改善预测的“环境变量”，目标始终是“下一期因子多空收益”。

---

### 3. 构建机器学习样本：输入是过去一段时间和当前状态，输出是“下一期因子多空收益”

在做 LSTM 模型时，我们这样构造样本：

* 给定某一时间 t，对应：

  * 因子多空收益：r_t（一个 10 维向量）
  * Regime 状态：regime_t（用 one-hot 变为额外特征）
* 构造一个长度为 12 的时间窗口：

  * 输入 X_t = [r_{t-11}, r_{t-10}, …, r_t] + regime_t
  * 输出 y_t = r_{t+1}

也就是说，我们让模型学习：
在过去 12 个月中各因子是怎么表现的、当前处于什么 Regime、在这种环境下**下一期各因子的多空收益会怎样**。

从数学上讲：

* 输入：
  [
  X_t = {r_{t-11}, r_{t-10}, ..., r_t, Regime_t}
  ]
* 输出：
  [
  y_t = r_{t+1} = (r_{t+1}^{MOM20}, ..., r_{t+1}^{BETA})
  ]

这正是你在 LSTM 代码里做的事情：`y` 的每一行就是“下一期因子多空收益”的真实值，模型训练的目标就是拟合这个向量。

---

### 4. 训练完成后：模型输出的仍然是“下一期因子多空收益的预测值”

当我们把训练好的 LSTM 用在测试集上时，得到的预测矩阵 y_pred：

* 每一行对应某个月 t 对应的**未来一个月 t+1 的因子多空收益预测**；
* 每一列对应一个因子，例如：

  * MOM20_pred 对应预测的 ( \hat{r}_{t+1}^{MOM20} )
  * PB_pred 对应预测的 ( \hat{r}_{t+1}^{PB} )
  * …

这些预测值就写进了 factor_prediction.csv：

* month（通常是“预报生效的那个月”，即 t+1 或对齐后的日期）
* MOM20_pred, MOM120_pred, …, BETA_pred

从头到尾，预测的对象始终是“**下一期因子多空收益**”，没有改变过。

---

### 5. 为什么用“下一期因子多空收益预测”来做权重，而不是别的东西？

从投资决策的角度，我们希望在每次调仓日 t 做这样一件事：

> 根据目前掌握的信息，估计出未来一个月内不同因子组合的预期表现，然后把仓位更多地给预期强的因子。

而“未来一个月每个因子的多空收益预测”恰好就是：

[
\hat{r}_{t+1}^{factor}
]

这正是资产配置里的核心输入：**期望收益**。
因此，用 LSTM 预测出来的每个因子多空收益，自然成为了构造因子权重的基础。

我们做的事情可以写成公式：

1. 先预测每个因子下一期的多空收益：
   [
   \hat{r}_{t+1} = f(X_t)
   ]

2. 再把这个预测向量通过 softmax 映射为权重：
   [
   w_{t+1,i} = \frac{\exp(\hat{r}*{t+1,i})}{\sum_j \exp(\hat{r}*{t+1,j})}
   ]

这样得到的 ( w_{t+1} ) 是一个合法的因子权重向量（非负且和为 1），用来构建下个月的因子组合。

注意，这里我们并没有直接预测股票权重或组合收益，而是先从因子层面预测“哪一类风格会更强”，再在因子层面做轮动。这是多因子投资中常见的一种层次设计：**先预测因子回报，再通过因子回报决定股票组合。**

---

### 6. 从预测值到权重：仍然是围绕“下一期因子多空收益”

你看到的 softmax 转换其实可以理解为一个“从收益观点到权重决策”的映射：

* 输入：每个因子的下一期预期多空收益 ( \hat{r}_{t+1}^{factor} )
* 输出：每个因子的下一期配置比例 ( w_{t+1}^{factor} )

前者来自 LSTM 模型，后者用于投资组合。

从逻辑上看，这两者紧密绑定：

1. 如果模型预期某个因子的多空收益更高，softmax 会给它更大的权重；
2. 如果模型预期某个因子收益很差，权重会自动压低；
3. 如果所有预测差不多，权重接近等权，策略就退化为类似静态因子组合。

整个 pipeline 其实就是一条链：

> 过去的因子多空收益 + Regime → 预测下一期因子多空收益 → 将预测收益转为因子权重 → 根据权重构建因子组合 → 进行回测。

这条链上的“核心变量”始终是“下一期因子多空收益”。

---

### 7. 回测视角：为什么这件事证明了“因子轮动策略”的有效性？

最后，当你在天软里用 factor_weights_dynamic.csv 做回测时，本质上是在检验：

* 如果每个月我们都能用 LSTM 较好地预估“下一期哪些因子会赚钱”，并按预估强弱动态调整权重，
* 是否能够得到比“静态等权因子组合”更好的收益/风险表现。

这里验证的就是“能否捕捉因子轮动”：

* 因子轮动本身：由前面的 Regime 分析和分 Regime 因子表现验证；
* 对轮动的利用：由“下一期因子多空收益预测 → 因子权重 → 回测收益”这一套流程来检验。

如果回测结果显示动态策略 Sharpe 更高、回撤更小或收益更优，就说明模型确实在一定程度上捕捉到了因子轮动的可预测部分。

