## 第一部分：研究动机与因子轮动的理论背景
本研究的核心目标是验证并构建一套基于机器学习的因子轮动策略。既有文献和大量实证研究指出，各类风格因子（如动量、价值、质量、波动、规模等）的表现并不是稳定不变的，而是随着市场状态的变化呈现出明显的周期性和阶段性差异。例如，动量因子往往在趋势明显的市场环境中表现较好，而价值因子在市场恐慌或下跌阶段相对抗跌，质量因子在震荡市中收益稳健。这种依赖市场状态的差异化表现构成了因子轮动理论的基础：如果能够识别当前市场所处的状态，并提前预测下一期不同因子的表现，就有机会在因子间实现动态配置，从而获得优于静态多因子组合的收益与风险暴露。基于这一背景，本研究希望通过因子构建、市场状态识别、机器学习预测与策略回测的完整流程，验证因子轮动策略在上证50股票池中的有效性。

## 第二部分：数据来源与预处理
本项目的数据分为两类：因子层面数据和市场状态识别数据。因子数据基于上证50指数成分股的横截面选股因子构建，包括动量类（MOM20、MOM120、RSI）、价值类（PB、PE、DIV）、质量类（ROE、利润增长率）、风险类（VOL、BETA）等因子的多空收益时间序列。这些数据来自天软金融工程平台，通过对上证50成分股进行月度排序、分组以及多空组合收益计算得到，并最终整理输出为数据文件 factor_longshort.csv。市场状态数据来自上证50指数本身，包括指数月末收盘价、月度收益、月度成交量总和、成交量变化、20日与60日年化波动等特征。这些指标用于刻画宏观层面的市场风险偏好与波动环境，构建为 sh000016_monthly_features 数据集，再通过聚类生成 cluster_info 文件。所有日期均统一处理为每月的第一天，确保不同数据源在时间上完全对齐。

## 第三部分：因子轮动理论的验证逻辑
为了验证因子轮动的可行性，首先需要确认两个关键事实。第一，不同因子在不同市场阶段下的表现具有显著差异，这种差异体现了因子收益的状态依赖性。第二，市场状态本身具有可识别性与相对稳定性，即能够通过市场特征提取出不同风险环境的分类，从而在时间序列上表现出一定的结构性。若这两个前提成立，则可以在后续利用模型预测未来因子表现，并以此执行因子权重调整。因此，本研究首先使用上证50指数特征进行市场状态识别，其后再统计因子在不同 Regime 下的收益分布，以验证因子轮动的存在性根基。

## 第四部分：市场状态（Regime）识别
市场状态识别的目标是将市场环境自动划分为若干类别，使不同状态对应的市场特征具有统计上的显著差异。本项目基于上证50指数构建以下特征：月度收益 ret_month、20日年化波动、60日年化波动、月度成交量总和、成交量变化等。通过对这些特征标准化后使用 KMeans 聚类进行市场状态划分。聚类数通过 Silhouette Score 选择，最终得到三个 Regime，分别对应市场上升阶段、市场下跌/高波动阶段、以及震荡弱趋势阶段。聚类结果生成 cluster_info 文件，包含每个月的 Regime 标签。随后对因子收益在不同 Regime 下进行平均收益、标准差与夏普比统计，用于验证因子收益是否具有状态依赖性。实证结果通常显示动量因子在趋势市场中表现最佳，而价值和低波动因子在高风险状态下具有相对防御作用，这为因子轮动提供了直接证据。

## 第五部分：构建模型训练数据集
在完成因子收益与 Regime 数据的合并之后，生成最终的数据表 final_factor_longshort.csv。这张表包含每个月的所有因子多空收益以及对应的市场状态标签，是后续模型训练的唯一中心数据源。为了构造机器学习模型所需的时序输入，需要使用滑动窗口方法：过去12个月的因子收益作为输入 X，下一期的因子收益作为输出 y。同时，为了使模型能够学习市场状态的影响，需要将 Regime 标签转换为 one-hot 编码并作为额外特征加入到输入序列中。在样本划分方面，本研究采用 7:2:1 的时间顺序划分方式，即前70%的数据作为训练集，中间20%为验证集，最后10%为测试集。这种划分避免了数据泄漏，保持实际预测场景的时间先后关系。

## 第六部分：构建因子轮动预测模型
本研究可选用多任务回归模型，例如 LSTM、GRU、Transformer，或传统机器学习模型如随机森林与 XGBoost，目标是同时预测下一期的多个因子收益（多任务输出）。模型输入为过去12个月的因子收益与 Regime 状态，输出为下一期的十个因子收益向量。模型使用 MSE 或 Huber loss 进行训练，训练过程中通过验证集进行超参数调优。训练完成后，在测试集上生成下一期因子收益预测并输出为 factor_prediction.csv 文件。

## 第七部分：从预测因子收益到因子权重
为了将预测结果转化为可执行的因子配置方案，需要将预测因子收益向量映射到一组权重。常用的方法是使用 softmax，将所有预测值转换为权重，使其非负且和为1。权重文件输出为 factor_weights_dynamic.csv，包含每个月对应的动态因子权重。这些权重将在天软回测框架中作为动态因子组合策略的输入，用于模拟真实投资表现。

## 第八部分：动态因子策略回测
在天软平台中构建一个继承自 TSMultiFactor 的子类，重写 GetFactors 方法，使其在每期调仓日读取动态因子权重文件，并据此计算因子组合收益。回测需要与基准策略进行比较，包括：静态等权因子组合、多因子线性组合、以及单因子策略。回测指标包括年化收益率、波动率、最大回撤、夏普比率等，用于评估动态因子轮动策略是否具有显著优势。

## 第九部分：策略可解释性与 LLM 输出
为了提升因子轮动策略的透明度与可解释性，本项目引入大型语言模型（LLM）对因子权重变化进行自然语言解释。输入包括因子历史收益、预测值、当前 Regime 等信息，通过提示词模板让 LLM 自动生成解释文本，例如“为何动量因子在某月被提升权重”或“为何价值因子在高波动环境中权重增加”。输出文件可用于策略展示或报告撰写。

## 第十部分：总结与交付内容
最终项目形成一套完整的研究闭环，包括因子数据构建、市场状态识别、因子轮动理论实证、机器学习预测模型、动态权重生成、回测分析以及 LLM 可解释性模块。交付内容包括数据文件、训练与预测脚本、可视化图表、回测报告、策略说明文档与展示材料，能够完整展示因子轮动策略从理论到实践的可行性与实际表现。